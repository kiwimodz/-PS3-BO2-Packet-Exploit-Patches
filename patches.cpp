//Credits - kiwi_modz - Synful - Faultz - InUrFace - 20-02-2023
		
void CG_DeployServerCommand(int localClientNum) {
	int iCommand = *(uint8_t*)Cmd_Argv(0);

	switch (iCommand) {

	case 105:
		int iTeamNum = _atoi(Cmd_Argv(1));
		if (iTeamNum < 0 || iTeamNum > 10) {//max team RME exploit
			UI_OpenToastPopup(0, "hud_obit_death_suicide", "^1EXPLOIT DETECTED", "RME", 5000);//RME
			std::strcpy((char*)Cmd_Argv(0), "");
			return;
		}
	case 55:
		return;

	case 50:
		if (!g_vars->local.is_host) {
			if (_atoi(Cmd_Argv(1)) == 2689) {//Register item RCE exploit
				if (_atoi(Cmd_Argv(2)) >= 0x100) {
					UI_OpenToastPopup(0, "hud_obit_death_suicide", "1EXPLOIT DETECTED", "RCE", 5000);//RME
					std::strcpy((char*)Cmd_Argv(0), "");
					return;
				}
			}
		}
	}
}

void SV_PacketEvent(netadr_t from, msg_t* msg)
{
	pcrash = false;
	char buffer[200];

	SV_PacketEvent_d->invoke(from, msg);

	if (pcrash)
	{
		auto client_num = Party_FindMember(get_current_party(), from);
		char buffer[100];
		Com_Sprintf(buffer, sizeof(buffer), "Server Exploit From %s Blocked", cg->clients[client_num].PlayerName);
		SV_GameSendServerCommand(buffer);
	}
}

unsigned int MSG_ReadShort_h(msg_t* msg) {

	unsigned int ret = MSG_ReadShort_d->invoke<unsigned int>(msg);

	if (__builtin_return_address() == (void*)0x00332BDC) {//fragmentSize

		if (ret > 1232)
		{
			pcrash = true;
			return 0;
		}
	}

	if (__builtin_return_address() == (void*)0x00332BE8) {//fragmentLength

		if (ret > 1232)
		{
			pcrash = true;
			return 0;
		}
	}

	return ret;
}

unsigned int MSG_ReadByte_h(msg_t* msg) {

	unsigned int ret = MSG_ReadByte_d->invoke<unsigned int>(msg);
	if (__builtin_return_address() == (void*)0x00332BC4) {//fragmentIndex
		if (ret > 127)
		{
			pcrash = true;
			return 0;
		}
	}
	return ret;
}

void SV_ExecuteClientMessage(client_t* client, msg_t* msg)
{
	auto client_num = Party_FindMember(get_current_party(), client->header.netchan.remoteAddress);

	if (client->reliableAcknowledge < 0)
	{
		if (client_num) {
			char buffer[100];
			Com_Sprintf(buffer, sizeof(buffer), "Server Exploit From %s Blocked", cg->clients[client_num].PlayerName);
			SV_GameSendServerCommand(buffer);

			client->reliableAcknowledge = client->reliableSequence;
		}
	}

	if ((client->reliableSequence - client->reliableAcknowledge) > 127)
	{
		if (client_num) {
			char buffer[100];
			Com_Sprintf(buffer, sizeof(buffer), "Server Exploit From %s Blocked", cg->clients[client_num].PlayerName);
			SV_GameSendServerCommand(buffer);

			client->reliableAcknowledge = client->reliableSequence;
		}
	}

	SV_ExecuteClientMessage_d->invoke(client, msg);
}